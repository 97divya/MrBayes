Content
=======
1) How to compile MrBayes from source
2) Configuration options
3) Troubleshooting compilation problems
4) Further references


How to compile MrBayes from source
==================================

Pre-requirements:

You will need the following software to build MrBayes:
* gcc (or other C++ compiler) (version 4.6 or later)
* autotools (autoconf, automake, etc)
* Optional: MPI compiler and library
* Optional: Beagle library

Compilation: 
For instructions on how to compile MrBayes on a Mac, see below. To compile MrBayes
in other UNIX-like environments, first navigate to the folder containing the source
code. Then execute the following commands in your terminal:

> autoconf
> ./configure 
> make

The compilation will produce an executable in the source directory with the name
"mb". To start the program, simply type

> ./mb

For more convenient access to the program, you may want to install it in your
path, in which case you can invoke the program from any directory on your
computer by simply typing

> mb

If you wish to make the program available to all users in this way, you can use

> sudo make install

after having compiled the program.


Configuration options
=====================

1) BEAGLE

MrBayes 3.2 uses the BEAGLE library by default. You should either install the
BEAGLE library from http://code.google.com/p/beagle-lib/ or disable use of the
library by invoking the configure script with option "--with-beagle=no". i.e. 

> ./configure --with-beagle=no

Note: without beagle library MrBayes may run slower.


2) SSE code

All main-stream modern processors have support for SSE instructions 
which are utilized by default by MrBayes 3.2 in order to substantially speed up
execution. If you experience problems with the SSE code, you can disable the use of
SSE code by invoking the configure script with the option "--enable-sse=no", i.e.

> ./configure --enable-sse=no

If you use SSE code, you may encounter problems with older compilers. Specifically,
if you are getting errors about undefined references to "posix_memalign", you should
update your compiler. You should have libc library of at least version 2.1.91 for
the SSE code to compile.


3) MPI version

To make use of MPI code to parallelize MrBayes computations across several processors
or CPU cores, you should invoke the configure script with the option
"--enable-mpi=yes". The MPI code can be used both together with the Beagle library
and the SSE code. Your computer also needs to have an MPI implementation installed,
for instance OpenMPI or MPICH, and the environment needs to be set up to run MPI
programs. To install an MPI version of MrBayes using BEAGLE and SSE, use:

> autoconf
> ./configure --enable-mpi=yes
> make

The resulting program will be called mb. A typical run might be started with a
command like:

> mpirun -np 8 mb data.nex > output.txt &

This will run MrBayes on eight processors or cores (-np 8), using the data file
"data.nex" as input. The output will not be printed to screen but to the file
"output.txt" (> output.txt). The ampersand (&) causes the control to return
immediately to the console, while the job will continue running in the background.

To examine the most recent output from the run, you might e.g. use the tail command
of UNIX like this:

> tail -f output.txt

This will print the lines onto the screen as they get added to the file "output.txt".
To stop the output, simply press ctrl-C (this will stop the output from the tail
command, it will not stop the MrBayes run).


Compiling on a Mac
=================

The standard modified gcc version shipping with Xcode is too old to compile
MrBayes (see gcc version requirement above). Also, Xcode no longer ships
with autotools, including autoconf that is used by MrBayes and most other
open source Unix software packages. We have had good experience using MacPorts
(http://www.macports.org) to install autoconf gcc, openmpi and other open-source
tools. Other options are Homebrew (http://mxcl.github.io/homebrew/) or GNU
(http://www.gnu.org).

To install the version 4.7 of gcc from MacPorts, use the following command
after having installed MacPorts:

> sudo port install gcc47

Check the web for the latest version of gcc. MacPorts does not allow you to
just say gcc, you need to specify the version number you want.

To install autoconf, use:

> sudo port install autoconf

To install the most recent version of openmpi, type:

> sudo port install openmpi

For your environment to work as expected, a little afterwork is required.
Just installing the newest versions from macports does not make simple
commands liken 'gcc', 'mpicc' and 'mpirun' point to those versions. One
solution is to always substitute those commands with the full path to the
macports versions, which are

> /opt/local/bin/gcc-mp-4.7     for 'gcc'
> /opt/local/bin/openmpicc      for 'mpicc'
> /opt/local/bin/openmpirun     for 'mpirun'

This will necessitate that you edit the Makefile produced by the configure
script of MrBayes. For the serial version, replace 'gcc' with the full
path to the macports version of gcc. For the MPI version, replace 'mpicc'
with the full path to the macports version. Note that this requires you
to launch the MPI version of mrbayes by using the command 'openmpirun'
instead of the usual 'mpirun'.

Alternatively, you can create symbolic links from the default locations of
'gcc', 'mpicc' and 'mpirun'. Note that this will replace symbolic links to
Apple's versions of those tools, which might possibly cause problems with
Xcode. Anyway, if you wish to go ahead and create those links, use the
following commands:

> sudo ln -s /opt/local/bin/openmpicc  /usr/local/bin/mpicc
> sudo ln -s /opt/local/bin/openmpirun /usr/local/bin/mpirun
> sudo ln -s /opt/local/bin/gcc-mp-4.7 /usr/local/bin/gcc

After you have created those links, you can use the simple commands 'gcc',
'mpicc' and 'mpirun' from anywhere on your system, and they will call the
macports versions you just installed.

Once you have installed autoconf, a recent version of gcc and openmpi you
can install the different versions of MrBayes as in a standard Unix
environment (see above).


Troubleshooting compilation problems
====================================

Problem: The compilation process hangs on model.c. For instance, this happens
when using the compiler that currently ships with Xcode (in the command line
tools).

Solution: Install a newer compiler. For instructions on how to install a newer
gcc version for Mac from MacPorts, see above.


Further references
==================
See the manual for more compilation/installation instructions.
